// Bach's Initialization Script

/open https://github.com/sormuras/bach/raw/main/boot

var gitignore = Path.of(".bach/.gitignore")
if (Files.notExists(gitignore)) {
  System.out.println();
  System.out.println("Generate default " + gitignore + " configuration");
  Files.write(Path.of(".bach/.gitignore"), List.of("/workspace/", "", "*.jar"));
}

var action = Path.of(".bach/action.sh")
if (Files.notExists(action)) {
  System.out.println();
  System.out.println("Generate launcher script");
  var command = "java --module-path " + Path.of(".bach/cache") + " --module com.github.sormuras.bach";
  Files.write(action, List.of("/usr/bin/env " + command + " \"$@\"")).toFile().setExecutable(true);
  Files.write(Path.of(".bach/action.bat"), List.of("@ECHO OFF", command + " %*"));
}

var build = Path.of(".bach/build.sh")
if (Files.notExists(build)) {
  System.out.println();
  System.out.println("Generate build script");
  var command = "java --module-path " + Path.of(".bach/cache") + " --module com.github.sormuras.bach build";
  Files.write(build, List.of("/usr/bin/env " + command + " \"$@\"")).toFile().setExecutable(true);
  Files.write(Path.of(".bach/build.bat"), List.of("@ECHO OFF", command + " %*"));
}

var version = Path.of(".bach/version.sh")
if (Files.notExists(version)) {
  System.out.println();
  System.out.println("Generate version script");
  var command = "java --module-path " + Path.of(".bach/cache") + " --module com.github.sormuras.bach version";
  Files.write(version, List.of("/usr/bin/env " + command)).toFile().setExecutable(true);
  Files.write(Path.of(".bach/version.bat"), List.of("@ECHO OFF", command));
}

var update = Path.of(".bach/update.sh")
if (Files.notExists(update)) {
  System.out.println();
  System.out.println("Generate update script");
  Files.writeString(update,
    """
    #!/usr/bin/env bash
    jshell -R-Dreboot -R-Dversion=${1:-early-access} https://bit.ly/bach-main-init
    """).toFile().setExecutable(true);
  Files.writeString(Path.of(".bach/update.bat"),
    """
    @ECHO OFF
    IF [%1]==[] (SET version=early-access) ELSE (SET version=%1)
    jshell -R-Dreboot -R-Dversion=%version% https://bit.ly/bach-main-init
    """);
}

System.out.println(
  """

  Bach initialized.

  .bach/action [ACTION [ARGS...]]
      Launch Bach's main program handling the specified action and passing
      optional arguments to the action handler.

  .bach/build [ARGS...]
      Convenient short-cut for ".bach/action build [ARGS...]"

  .bach/update [VERSION]
      Update Bach to the specified version. If no version argument is given
      an early-access version of Bach is downloaded and cached.

  .bach/version
      Convenient short-cut for ".bach/action version"

  Have fun! https://github.com/sponsors/sormuras (-:
  """
)

/exit
